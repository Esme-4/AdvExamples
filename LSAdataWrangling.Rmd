---
title: "LSAdata OneWay ANOVA"
author: "F.A. Barrios"
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    highlight: kate
---

```{r setup, include=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="80")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=80)
```
```{r}
# loading libraries
library(tidyverse)
```

# One-way ANOVA data preparation (Wrangling)
## LDS Daniel chap 8  LSA_DATA  
One-way ANOVA exercises with large data sets.  
Refer to the serum lipid-bound sialic acid data on 1400 subjects (LSADATA). We wish to conduct a study to determine if the measurement of serum lipid-bound sialic acid (LSA) might be of use in the detection of breast cancer. The LSA measurements (mg/dl) are for four populations of subjects: normal controls, A; patients with benign breast disease, B; patients with primary breast cancer, C; and patients with recurrent metastatic breast cancer, D. Select a simple random sample of size 10 from each population and perform an appropriate analysis to determine if we may conclude that the four population means are different.Let $\alpha = .05$ and determine the p value.  

## Data import and tibble format  
First we read the large data set (LDS) for the serum lipid-bound sialic acid data on 1400 subjects (LSADATA).  

```{r}
# Reading from the stat class directory

LSAdata <- read_csv("~/Dropbox/GitHub/ProbEstad/DataSets/ch08_all/LDS_C08_LSADATA.csv")
LSAdata
```

Froma the raw data file the format is a tibble with variables for column and data point by rows, nevertheless to excecute a one-way ANOVA we need to [wrangle](https://en.wikipedia.org/wiki/Data_wrangling) the data. Start by changing the column names according to the LDS problem description: Subject_number:Col1, Controls:Col2 patients with benign breast disease (BBD):Col3, patients with primary breast cancer (PBC):Col4 patients with recurrent metastatic breast cancer (RMBC)  
The original data is in table form and we need to change it to "long" format. And then to do the ANOVA we need to make the `Type` of cancer variable a factor and then re-level to group and compare to `Cont. 
```{r}
LSAdata <- LSAdata %>% 
  rename(Subj = Col1, Cont = Col2, BBD = Col3, PBC = Col4, RMBC = Col5)
LSAdata

LSAdata_n <- LSAdata %>% 
  select(Cont, BBD, PBC, RMBC)
LSAdata_n
```

For the estimation of a model in ANOVA (and lm) the data most be in a "long format". To set the data in Type and LSA numbers in long format we "pivot" the data. Then we re-level the factors otherwise the categorical variables are ordered in alphabetical order and the comparisons are based in this order.  

```{r}
# Make LSAdata long
LSAdata_long <- LSAdata_n %>%
  pivot_longer(cols = everything(), names_to = "Type", values_to = "LSA")
LSAdata_long

# Make the Type variable a factor and re-level to compare to Cont
LSAdata_long <- LSAdata_long %>% 
  mutate( Type = factor(Type) )

LSAdata_long <- LSAdata_long %>% 
  mutate( Type = Type %>% fct_relevel("Cont","BBD","PBC","RMBC") )
```

## BoxPlot (by formula)

If the data model has benn setup correctly we can make a boxplot and it should have the right factor order (now, are the variables factors?) and if the plot looks "right" then we can assume that que data has the required form.  
The easiest way is the simplest plot using a `boxplot` with the model of our data. 

```{r}
# boxplot(LSA ~ Type, data = LSAdata_long)
# nicer
LSAdata_long %>% ggplot(aes(x = Type, y = LSA)) +
    geom_boxplot() +
#   geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), scale = "area") +
    geom_jitter(aes(colour = Type), shape = 16, position = position_jitter(seed = 123)) +
    labs(title = "Measurement of serum Lipid-bound Sialic Acid (LSA)") +
    theme_bw()
              
```

# One-way ANOVA model estimation  

## Simple model estimation  
Now we estimate the model we know the data is in the right form (pivot_longer), and the categorical variable (factor) is ordered now. To estimate the ANOVA we can use the `aov` R function or the `lm` function at this point they are equivalent, and showing the results we use car function `Anova` or the R function `anova` can be used too. 

```{r}
library(car)
# for the Anova function

# running a lm model for the ANOVA
LSAdata_lm <- lm(LSA ~ Type, data = LSAdata_long)
Anova(LSAdata_lm)
LSAdata_aov <- aov(LSA ~ Type, data = LSAdata_long)
Anova(LSAdata_aov)
summary(LSAdata_aov)
```

## Post Hoc estimation  
After running an ANOVA model estimation the next step is to determine which group means are significantly different from one another.  There are different *post hoc* types of tests, the most common for parametric estimation of the model are Tukey HSD and Dunnett's tests.  
The library `emmeans` has a function to estimate the Tukey and 95% confidence intervals first the pairwise comparisons with the Control group and contrasts, and then we will compare each cancer condition to control to show if the averages are significant different. If the call to emmeans is with the factor `pairwise` emmeans function estimates a Tukey HSD pairwise for all the factor levels. If the call to emmeans is made with treatment vs. control the function estimates a Dunnett's test comparing the control average (first factor) to the rest, to determine the significant difference.  

```{r}
library(emmeans)

# Use emmeans to look for estimating the Tukey and 95% confidence intervals
emmeans(LSAdata_lm, pairwise ~ Type)
emmeans(LSAdata_lm, trt.vs.ctrl ~ Type)
```
