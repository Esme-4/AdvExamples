---
title: "LSAdata OneWay ANOVA"
author: "F.A. Barrios"
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    highlight: kate
    toc: TRUE
---

```{r setup, include=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="80")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=80)
```
```{r}
# loading libraries
library(tidyverse)
library(car)
library(emmeans)
library(rstatix)
library(multcomp)
library(ggstatsplot)
library(scales)
```

# One-way ANOVA  
## LDS Daniel chap 8  LSADATA  
One-way ANOVA exercises with large data sets.  
Refer to the serum lipid-bound sialic acid data on 1400 subjects (LSADATA). We wish to conduct a study to determine if the measurement of serum lipid-bound sialic acid (LSA) might be of use in the detection of breast cancer. The LSA measurements (mg/dl) are for four populations of subjects: normal controls, A; patients with benign breast disease, B; patients with primary breast cancer, C; and patients with recurrent metastatic breast cancer, D. Select a simple random sample of size 10 from each population and perform an appropriate analysis to determine if we may conclude that the four population means are different.Let $\alpha = .05$ and determine the p value.  

## Data import and tibble format  
First we read the large data set (LDS) for the serum lipid-bound sialic acid data on 1400 subjects (LSADATA).  

```{r}
# Reading from the stat class directory

LSAdata <- read_csv("~/Dropbox/GitHub/ProbEstad/DataSets/ch08_all/LDS_C08_LSADATA.csv")
LSAdata
```

Now change the column names according to the LDS description: Subject_number:Col1, Controls:Col2 patients with benign breast disease (BBD):Col3, patients with primary breast cancer (PBC):Col4 patients with recurrent metastatic breast cancer (RMBC)  
The original data is in table form and we need to change it to "long" format. And then to do the ANOVA we need to make the `Type` of cancer variable a factor and then re-level to group and compare to `Cont. 
```{r}
LSAdata <- LSAdata %>% 
  rename(Subj = Col1, Cont = Col2, BBD = Col3, PBC = Col4, RMBC = Col5)
LSAdata_n <- LSAdata %>% 
  select("Cont", "BBD", "PBC", "RMBC")
```

For the estimation of a model in ANOVA (and lm) the data most be in a "long format". To set the data in Type and LSA numbers in long format we "pivot" the data.  

```{r}
# Make LSAdata long
LSAdata_long <- LSAdata_n %>%
  pivot_longer(cols = everything(), names_to = "Type", values_to = "LSA")
  
# Make the Type variable a factor and re-level to compare to Cont
LSAdata_long <- LSAdata_long %>% 
  mutate( Type = factor(Type) )
LSAdata_long <- LSAdata_long %>% 
  mutate( Type = Type %>% fct_relevel("Cont","BBD","PBC","RMBC") )
```

## BoxPlot (by formula)

If the data model has benn setup correctly we can make a boxplot and it should have the right factor order (now, are the variables factors?) and if the plot looks "right" then we can assume that que data has the required form.  
The easiest way is the simplest plot using a `boxplot` with the model of our data. 

```{r}
# boxplot(LSA ~ Type, data = LSAdata_long)
# nicer
LSAdata_long %>% ggplot(aes(x = Type, y = LSA)) +
    geom_boxplot() +
#   geom_violin(draw_quantiles = c(0.25, 0.5, 0.75), scale = "area") +
    geom_jitter(aes(colour = Type), shape = 16, position = position_jitter(seed = 123)) +
    labs(title = "Measurement of serum Lipid-bound Sialic Acid (LSA)") +
    theme_bw()
              
```

## One-way ANOVA  
We can use the `aov` or the `lm` function to estimate model. Save the model to a variable for processing and estimating the contrasts.  

```{r}
LSAdata_lm <- lm(LSA ~ Type, data = LSAdata_long)
Anova(LSAdata_lm)
```

followed by estimating a Tukey using the `emmeans` function at 95% confidence intervals, to compare between the adjusted parameters,  first the pairwise comparisons with the Control group and contrasts then cancer condition compared to control.  

```{r}
emmeans(LSAdata_lm, pairwise ~ Type)
emmeans(LSAdata_lm, trt.vs.ctrl ~ Type)
```

Now using the library `rstatix`. The rstatix library provides a very compete set of "wrappers for statistical tests" for parametric and non-parametric tests, using the R base functions as internal engine, of other libraries and has several very useful ANOVA functions. It also has an emmeans interface.  

```{r}
LSAdata.aov <- LSAdata_long %>% anova_test(LSA ~ Type, effect.size = "ges", detailed = TRUE)
get_anova_table(res.aov)
# with emmeans
LSAdata_long %>% emmeans_test(LSA ~ Type, p.adjust.method = "fdr", detailed = TRUE)
```

## A non-parametric comparison

Now the same hypotesis test but using a non-parametric tests. For a one-Way ANOVA we use a Kruskal-Wallis estimation and effects size estimate and Dunn test all using the `rstatix` library.

```{r}
res.kruskal <- LSAdata_long %>% kruskal_test(LSA ~ Type)
res.kruskal

# And estimate the Kruskal effect size
LSAdata_long %>% kruskal_effsize(LSA ~ Type)
# To estimate the pairwise corrected by multiple comparisons the Dunn's Test
pc_LSAdata <- LSAdata_long %>% dunn_test(LSA ~ Type, p.adjust.method = "fdr")
```


